<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Â¡Realiza tu pedido!</title>
    <link rel="stylesheet" href="/css/verMenus.css">
</head>
<body>

<h1>Â¡Realiza tu pedido!</h1>

<form action="/pedido/confirmarPedido" method="post" id="formConfirmarPedido">
    <input type="hidden" name="carrito" id="carritoData" />
    <input type="hidden" name="clienteId" th:if="${cliente != null}" th:value="${cliente.idUsuario}" />
    <input type="hidden" name="direccionId" id="direccionId" />
    <input type="hidden" name="metodoPago" id="metodoPagoHidden" />
    <input type="hidden" name="total" id="totalPedido" />

    <h2 th:if="${restaurante != null}" th:text="'MenÃºs de ' + ${restaurante.nombre}"></h2>
    <div th:if="${cartas != null and not #lists.isEmpty(cartas)}">
        <ul>
            <li th:each="carta : ${cartas}">
                <h3 th:text="${carta.nombre}"
                    th:attr="onclick='toggleItems(' + ${carta.id} + ')'"
                    style="cursor: pointer;">
                </h3>
                <ul th:id="'items-' + ${carta.id}" style="display: none;" th:if="${carta.items != null and not #lists.isEmpty(carta.items)}">
                    <li th:each="item : ${carta.items}">
                        <span th:text="${item.nombre}"></span> - <span th:text="'â‚¬' + ${item.precio}"></span>
                        <button type="button" th:attr="onclick='actualizarCarrito(-1, ' + ${item.id} + ', \'' + ${item.nombre} + '\', ' + ${item.precio} + ');'">-</button>
                        <span th:id="|cantidad-${item.id}|">0</span>
                        <button type="button" th:attr="onclick='actualizarCarrito(1, ' + ${item.id} + ', \'' + ${item.nombre} + '\', ' + ${item.precio} + ');'">+</button>
                    </li>
                </ul>
            </li>
        </ul>
    </div>
    <p th:if="${cartas == null or #lists.isEmpty(cartas)}">No hay menÃºs disponibles.</p>

    <!-- Resumen del pedido al final -->
    <div class="order-summary">
        <h3>Resumen del pedido</h3>
        <div th:if="${cliente != null}">
            <label for="direccionSelect">DirecciÃ³n de envÃ­o:</label>
            <select id="direccionSelect" onchange="actualizarDireccion()" required>
                <option value="">Selecciona una direcciÃ³n</option>
                <option th:each="direccion : ${cliente.direcciones}" th:value="${direccion.id}" th:text="${direccion.calle + ', ' + direccion.numero + ', ' + direccion.municipio}"></option>
            </select>
            <p id="direccionTexto" style="display: none;"></p>
        </div>
        <label for="metodoPagoSelect">MÃ©todo de pago:</label>
        <select id="metodoPagoSelect" onchange="actualizarMetodoPago()" required>
            <option value="">Selecciona un mÃ©todo de pago</option>
            <option value="PAYPAL">PayPal</option>
            <option value="CREDIT_CARD">Tarjeta de crÃ©dito</option>
        </select>
        <p id="metodoPagoTexto" style="display: none;"></p>
        <p id="total-precio">Total: â‚¬0.00</p>
        <button id="continuarPedido" style="display: none;" type="submit">Continuar con el pedido</button>
    </div>
</form>

<script>
    let carrito = {};

    function actualizarCarrito(cambio, itemId, itemNombre, itemPrecio) {
        console.log("ðŸ“Œ Actualizando carrito:", { cambio, itemId, itemNombre, itemPrecio });

        if (!carrito[itemId]) {
            carrito[itemId] = { nombre: itemNombre, precio: itemPrecio, cantidad: 0 };
        }
        carrito[itemId].cantidad += cambio;

        if (carrito[itemId].cantidad < 0) {
            carrito[itemId].cantidad = 0;
        }

        let cantidadElemento = document.getElementById(`cantidad-${itemId}`);
        if (cantidadElemento) {
            cantidadElemento.innerText = carrito[itemId].cantidad;
            console.log(`âœ… Se actualizÃ³ #cantidad-${itemId} a ${carrito[itemId].cantidad}`);
        } else {
            console.error(`âŒ No se encontrÃ³ el elemento #cantidad-${itemId}`);
        }

        let total = Object.values(carrito).reduce((acc, item) => acc + item.precio * item.cantidad, 0);
        document.getElementById("total-precio").innerText = `Total: â‚¬${total.toFixed(2)}`;
        document.getElementById("totalPedido").value = total.toFixed(2);

        let hayItems = Object.values(carrito).some(item => item.cantidad > 0);
        document.getElementById("continuarPedido").style.display = hayItems ? "block" : "none";

        let carritoSimplificado = {};
        for (let itemId in carrito) {
            if (carrito[itemId].cantidad > 0) {
                carritoSimplificado[itemId] = carrito[itemId].cantidad;
            }
        }

        console.log("ðŸ›’ Carrito simplificado:", carritoSimplificado);
        document.getElementById("carritoData").value = JSON.stringify(carritoSimplificado);
    }

    function actualizarDireccion() {
        let select = document.getElementById("direccionSelect");
        let texto = document.getElementById("direccionTexto");
        let hidden = document.getElementById("direccionId");
        if (select.value) {
            texto.innerText = `DirecciÃ³n seleccionada: ${select.options[select.selectedIndex].text}`;
            texto.style.display = "block";
            hidden.value = select.value;
        } else {
            texto.style.display = "none";
            hidden.value = "";
        }
        console.log("ðŸ“ DirecciÃ³n seleccionada: ", hidden.value);
    }

    function actualizarMetodoPago() {
        let select = document.getElementById("metodoPagoSelect");
        let texto = document.getElementById("metodoPagoTexto");
        let hidden = document.getElementById("metodoPagoHidden");
        if (select.value) {
            texto.innerText = `MÃ©todo de pago seleccionado: ${select.options[select.selectedIndex].text}`;
            texto.style.display = "block";
            hidden.value = select.value;
        } else {
            texto.style.display = "none";
            hidden.value = "";
        }
        console.log("ðŸ’³ MÃ©todo de pago seleccionado: ", hidden.value);
    }

    document.getElementById("formConfirmarPedido").addEventListener("submit", function(event) {
        let carritoSimplificado = {};
        for (let itemId in carrito) {
            if (carrito[itemId].cantidad > 0) {
                carritoSimplificado[itemId] = carrito[itemId].cantidad;
            }
        }
        if (Object.keys(carritoSimplificado).length === 0) {
            alert("Â¡Tu carrito estÃ¡ vacÃ­o!");
            event.preventDefault();
            return;
        }
        if (!document.getElementById("direccionId").value) {
            alert("Por favor, selecciona una direcciÃ³n de envÃ­o.");
            event.preventDefault();
            return;
        }
        if (!document.getElementById("metodoPagoHidden").value) {
            alert("Por favor, selecciona un mÃ©todo de pago.");
            event.preventDefault();
            return;
        }
        console.log("ðŸ“¤ Enviando formulario con carrito:", carritoSimplificado);
        document.getElementById("carritoData").value = JSON.stringify(carritoSimplificado);
    });

    function toggleItems(cartaId) {
        const itemsUl = document.getElementById(`items-${cartaId}`);
        if (itemsUl) {
            const visible = itemsUl.style.display === "block";
            itemsUl.style.display = visible ? "none" : "block";
        }
    }
</script>

</body>
</html>
